# Скрипт отправки статистики Nginx на email

Данный скрипт предназначен для отправки статистики веб-сервера Nginx на заданную почту. Скрипт формирует письмо, которое содержит следующую информацию:

  -  Список IP адресов (с наибольшим количеством запросов)
  -  Список запрашиваемых URL (с наибольшим количеством запросов)
  -  Ошибки веб-сервера/приложения
  -  Список всех кодов HTTP ответа

## Установка и настройка

Для работы скрипта необходимо наличие следующих компонентов:

  - `Bash`
  - `Nginx`
  - Утилита `mail` для отправки email

Скрипт не требует установки, его можно просто скачать и запустить.

Перед запуском необходимо настроить скрипт, указав в нем нужные параметры:

  - `LOG_FILE` - путь до файла с логами Nginx
  - `EMAIL` - почтовый адрес, на который будет отправляться статистика

### Установка утилиты mail

Для настройки утилиты mail на CentOS 7 необходимо выполнить следующие шаги:

1. Установить утилиту mail:

```bash 
sudo yum install mailx
```

2. Настроить файл ```/etc/aliases```, чтобы перенаправить все почтовые сообщения для root на желаемый почтовый адрес:

```bash
sudo nano /etc/aliases
```

Добавить строку:

```bash
root: example@example.com
```

3. После сохранения файла `/etc/aliases`, необходимо обновить базу данных алиасов командой `newaliases`:

```bash
sudo newaliases
```

Проверить, что утилита `mail` настроена корректно, отправив простое тестовое письмо на заданный почтовый адрес:

```bash
echo "Тестовое сообщение" | mail -s "Тест" example@example.com
```

Если всё настроено верно, то письмо должно быть успешно отправлено.

**Примечание**: Утилита `mail` использует установленный почтовый сервер для отправки почты. По умолчанию в CentOS 7 используется `Postfix`. Если `Postfix` не настроен, необходимо его настроить или установить и настроить другой почтовый сервер.

### Установка и настройка Postfix

`Postfix` - это агент передачи почты (MTA), который может использоваться для отправки почты с сервера. Вот как настроить Postfix на CentOS 7:

1. Установите Postfix:

```bash
sudo yum install postfix
```

2. Откройте файл конфигурации Postfix, используя текстовый редактор:

```bash
sudo vi /etc/postfix/main.cf
```

3. Найдите параметр `myhostname` и укажите имя хоста вашего сервера. Например:

```bash
myhostname = example.com
```

4. Найдите параметр `mydestination` и укажите список доменов, для которых Postfix является локальным почтовым сервером. Например:

```bash
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
```

5. Найдите параметр `inet_interfaces` и укажите, какие интерфейсы будут слушать запросы SMTP. Например:

```bash
inet_interfaces = all
```

6. Найдите параметр `myorigin` и укажите домен, который будет использоваться в качестве источника по умолчанию для отправляемых сообщений. Например:

```bash
myorigin = $mydomain
```

7. Найдите параметр `relayhost`, если вы используете сторонний почтовый сервер для отправки почты, и укажите адрес сервера. Например:

```bash
relayhost = smtp.example.com
```

8. Найдите параметр `mynetworks` и укажите список сетей, которым разрешено отправлять почту через этот сервер. Например:

```bash
mynetworks = 192.168.0.0/24, 10.0.0.0/8
```

9. Сохраните изменения и закройте файл конфигурации.

10. Перезапустите Postfix, чтобы применить изменения:

```bash
sudo systemctl restart postfix
```

Теперь Postfix настроен и готов к отправке почты.


## Использование

Для запуска скрипта можно использовать `Cron`. Например, для того чтобы отправлять статистику раз в час, нужно добавить в `Cron` следующую строку:

```bash
0 * * * * /path/to/script.sh
```

Если скрипт уже запущен, то он не будет запускаться повторно.

## Описание работы

  - Сначала скрипт проверяет, не запущен ли он уже. Если скрипт уже запущен, то он завершает работу.
  - Затем задаются настройки скрипта - путь до файла с логами и почтовый адрес.
  - С помощью утилиты `awk` из файла с логами Nginx извлекаются IP-адреса и запрашиваемые URL. Затем эта информация сортируется по количеству запросов и выводится на экран.
  - С помощью утилиты grep из файла с логами Nginx извлекаются ошибки веб-сервера/приложения с кодом `50x`. Затем эта информация выводится на экран.
  - С помощью утилиты `awk` из файла с логами Nginx извлекаются все коды HTTP ответа. Затем эта информация сортируется по количеству запросов и выводится на экран.
  - Сформированная статистика отправляется на почту.

После выполнения работы скрипт завершает свою работу.